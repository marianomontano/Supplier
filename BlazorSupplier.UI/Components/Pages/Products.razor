@using Microsoft.EntityFrameworkCore
@using Supplier.Core.Models
@using Supplier.Core.Services
@using Supplier.Core.Persistence

@page "/products"

@rendermode InteractiveServer
@inject ICacheService cacheService

<h3>Productos</h3>

@if (products is not null)
{
    <div class="mb-3">
        <EditForm Model="Search" OnSubmit="HandleSearch" FormName="searchForm">
            <div class="mb-3">
                <InputText id="search" class="form-control" @bind-Value="Search.Filter" />
            </div>
            <input type="submit" name="filter" value="Buscar" class="btn btn-primary me-2" />
            <button type="button" class="btn btn-secondary me-2" @onclick="ResetFilter">Reiniciar</button>
            <a class="btn btn-success me-2"
               href="@ExportExcelUrl"
               target="_blank">
                Exportar a Excel
            </a>
            <a class="btn btn-success"
               href="@ExportPDFUrl"
               target="_blank">
                Exportar a PDF
            </a>
        </EditForm>
    </div>

    <Pagination Items="products" PageSize="10" AutoResetOnItemsChanged="true">
        <ChildContentHeader>
            <tr>
                <th>Imagen</th>
                <th>Código</th>
                <th>Nombre</th>
                <th>Costo</th>
                <th>Público</th>
                <th>Categoría</th>
                <th>Stock</th>
                <th>Activo</th>
            </tr>
        </ChildContentHeader>

        <ChildContentRow Context="product">
            <tr>
                <td>
                    <img height="100" src="@product.ImageUrl" alt="@product.Name" />
                </td>
                <td>@product.Code</td>
                <td>@product.Name</td>
                <td>@product.Cost.ToString("C")</td>
                <td>@product.Public.ToString("C")</td>
                <td>@product.Provider</td>
                <td>@product.Stock</td>
                <td>@(product.IsActive ? "Sí" : "No")</td>
            </tr>
        </ChildContentRow>
    </Pagination>

}
else
{
    <p>Cargando productos...</p>
}

@code {
    List<ProductDto> products;
    List<ProductDto> productModels = [];
    CancellationTokenSource cancellationTokenSource = new();
    private SearchModel Search { get; set; } = new();
    private string ExportExcelUrl = "/api/export/excel";
    private string ExportPDFUrl = "/api/export/pdf";

    protected override async Task OnInitializedAsync()
    {
        productModels = await cacheService.GetOrSetProducts(cancellationTokenSource.Token);
        products = productModels.ToList();
    }

    private void ResetFilter()
    {
        Search.Filter = string.Empty;
        products = productModels.ToList();
    }

    private void HandleSearch(EditContext args)
    {
        var filter = Search.Filter?.Trim() ?? string.Empty;

        products = productModels
            .Where(x =>
                string.IsNullOrEmpty(filter) ||
                (x.Name?.Contains(filter, StringComparison.OrdinalIgnoreCase) ?? false) ||
                string.Equals(x.Code, filter, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private class SearchModel
    {
        public string Filter { get; set; } = string.Empty;
    }
}
